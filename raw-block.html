<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Raw Block Volume - Kubernetes CSI Developer Documentation</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="This site documents how to develop and deploy a Container Storage Interface (CSI) driver on Kubernetes.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="developing.html"><strong aria-hidden="true">2.</strong> Developing a CSI Driver for Kubernetes</a></li><li><ol class="section"><li><a href="kubernetes-changelog.html"><strong aria-hidden="true">2.1.</strong> Kubernetes Changelog</a></li><li><a href="kubernetes-cluster-controllers.html"><strong aria-hidden="true">2.2.</strong> Kubernetes Cluster Controllers</a></li><li><ol class="section"><li><a href="snapshot-controller.html"><strong aria-hidden="true">2.2.1.</strong> Snapshot Controller</a></li><li><a href="snapshot-validation-webhook.html"><strong aria-hidden="true">2.2.2.</strong> Snapshot Validation Webhook</a></li></ol></li><li><a href="sidecar-containers.html"><strong aria-hidden="true">2.3.</strong> Sidecar Containers</a></li><li><ol class="section"><li><a href="kubernetes-compatibility.html"><strong aria-hidden="true">2.3.1.</strong> Kubernetes Compatibility</a></li><li><a href="external-attacher.html"><strong aria-hidden="true">2.3.2.</strong> external-attacher</a></li><li><a href="external-provisioner.html"><strong aria-hidden="true">2.3.3.</strong> external-provisioner</a></li><li><a href="external-resizer.html"><strong aria-hidden="true">2.3.4.</strong> external-resizer</a></li><li><a href="external-snapshotter.html"><strong aria-hidden="true">2.3.5.</strong> external-snapshotter</a></li><li><a href="livenessprobe.html"><strong aria-hidden="true">2.3.6.</strong> livenessprobe</a></li><li><a href="node-driver-registrar.html"><strong aria-hidden="true">2.3.7.</strong> node-driver-registrar</a></li><li><a href="cluster-driver-registrar.html"><strong aria-hidden="true">2.3.8.</strong> cluster-driver-registrar</a></li><li><a href="external-health-monitor-controller.html"><strong aria-hidden="true">2.3.9.</strong> external-health-monitor-controller</a></li><li><a href="external-health-monitor-agent.html"><strong aria-hidden="true">2.3.10.</strong> external-health-monitor-agent</a></li></ol></li><li><a href="csi-objects.html"><strong aria-hidden="true">2.4.</strong> CSI objects</a></li><li><ol class="section"><li><a href="csi-driver-object.html"><strong aria-hidden="true">2.4.1.</strong> CSIDriver Object</a></li><li><a href="csi-node-object.html"><strong aria-hidden="true">2.4.2.</strong> CSINode Object</a></li></ol></li><li><a href="features.html"><strong aria-hidden="true">2.5.</strong> Features</a></li><li><ol class="section"><li><a href="secrets-and-credentials.html"><strong aria-hidden="true">2.5.1.</strong> Secrets &amp; Credentials</a></li><li><ol class="section"><li><a href="secrets-and-credentials-storage-class.html"><strong aria-hidden="true">2.5.1.1.</strong> StorageClass Secrets</a></li><li><a href="secrets-and-credentials-volume-snapshot-class.html"><strong aria-hidden="true">2.5.1.2.</strong> VolumeSnapshotClass Secrets</a></li></ol></li><li><a href="topology.html"><strong aria-hidden="true">2.5.2.</strong> Topology</a></li><li><a href="raw-block.html" class="active"><strong aria-hidden="true">2.5.3.</strong> Raw Block Volume</a></li><li><a href="skip-attach.html"><strong aria-hidden="true">2.5.4.</strong> Skip Attach</a></li><li><a href="pod-info.html"><strong aria-hidden="true">2.5.5.</strong> Pod Info on Mount</a></li><li><a href="volume-expansion.html"><strong aria-hidden="true">2.5.6.</strong> Volume expansion</a></li><li><a href="volume-datasources.html"><strong aria-hidden="true">2.5.7.</strong> Data Sources</a></li><li><ol class="section"><li><a href="volume-cloning.html"><strong aria-hidden="true">2.5.7.1.</strong> Cloning</a></li><li><a href="snapshot-restore-feature.html"><strong aria-hidden="true">2.5.7.2.</strong> Volume Snapshot &amp; Restore</a></li></ol></li><li><a href="ephemeral-local-volumes.html"><strong aria-hidden="true">2.5.8.</strong> Ephemeral Local Volumes</a></li><li><a href="volume-limits.html"><strong aria-hidden="true">2.5.9.</strong> Volume Limits</a></li><li><a href="volume-health-monitor.html"><strong aria-hidden="true">2.5.10.</strong> Volume Health Monitoring</a></li><li><a href="token-requests.html"><strong aria-hidden="true">2.5.11.</strong> Token Requests</a></li><li><a href="support-fsgroup.html"><strong aria-hidden="true">2.5.12.</strong> FSGroup Support</a></li></ol></li></ol></li><li><a href="deploying.html"><strong aria-hidden="true">3.</strong> Deploying a CSI Driver on Kubernetes</a></li><li><ol class="section"><li><a href="example.html"><strong aria-hidden="true">3.1.</strong> Example</a></li></ol></li><li><a href="testing-drivers.html"><strong aria-hidden="true">4.</strong> Driver Testing</a></li><li><ol class="section"><li><a href="unit-testing.html"><strong aria-hidden="true">4.1.</strong> Unit Testing</a></li><li><a href="functional-testing.html"><strong aria-hidden="true">4.2.</strong> Functional Testing</a></li></ol></li><li><a href="drivers.html"><strong aria-hidden="true">5.</strong> Drivers</a></li><li><a href="troubleshooting.html"><strong aria-hidden="true">6.</strong> Troubleshooting</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Kubernetes CSI Developer Documentation</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>ï»¿# Raw Block Volume Feature</p>
<h2><a class="header" href="#status" id="status">Status</a></h2>
<table><thead><tr><th>Status</th><th>Min K8s Version</th><th>Max K8s Version</th><th>external-provisioner Version</th><th>external-attacher Version</th></tr></thead><tbody>
<tr><td>Alpha</td><td>1.11</td><td>1.13</td><td>0.4</td><td>0.4</td></tr>
<tr><td>Alpha</td><td>1.13</td><td>1.13</td><td>1.0</td><td>1.0</td></tr>
<tr><td>Beta</td><td>1.14</td><td>1.17</td><td>1.1+</td><td>1.1+</td></tr>
<tr><td>GA</td><td>1.18</td><td>-</td><td>1.1+</td><td>1.1+</td></tr>
</tbody></table>
<h2><a class="header" href="#overview" id="overview">Overview</a></h2>
<p>This page documents how to implement raw block volume support to a CSI Driver.</p>
<p>A <em>block volume</em> is a volume that will appear as a block device inside the container.
A <em>mounted (file) volume</em> is volume that will be mounted using a specified file system and appear as a directory inside the container.</p>
<p>The <a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI spec</a> supports both block and mounted (file) volumes.</p>
<h2><a class="header" href="#implementing-raw-block-volume-support-in-your-csi-driver" id="implementing-raw-block-volume-support-in-your-csi-driver">Implementing Raw Block Volume Support in Your CSI Driver</a></h2>
<p>CSI doesn't provide a capability query for block volumes, so COs will simply pass through requests for
block volume creation to CSI plugins, and plugins are allowed to fail with the <code>InvalidArgument</code> GRPC
error code if they don't support block volumes. Kubernetes doesn't make any assumptions about which CSI
plugins support blocks and which don't, so users have to know if any given storage class is capable of
creating block volumes.</p>
<p>The difference between a request for a mounted (file) volume and a block volume is the <code>VolumeCapabilities</code>
field of the request. Note that this field is an array and the created volume must support ALL of the
capabilities requested, or else return an error. If the <code>AccessType</code> method of a <code>VolumeCapability</code>
<code>VolumeCapability_Block</code>, then the capability is requesting a raw block volume. Unlike mount volumes, block
volumes don't have any specific capabilities that need to be validated, although access modes still
apply.</p>
<p>Block volumes are much more likely to support multi-node flavors of <code>VolumeCapability_AccessMode_Mode</code>
than mount volumes, because there's no file system state stored on the node side that creates any technical
impediments to multi-attaching block volumes. While there may still be good reasons to prevent
multi-attaching block volumes, and there may be implementations that are not capable of supporting
multi-attach, you should think carefully about what makes sense for your driver.</p>
<p>CSI plugins that support both mount and block volumes must be sure to check the capabilities of all CSI RPC
requests and ensure that the capability of the request matches the capability of the volume, to avoid trying
to do file-system-related things to block volumes and block-related things to file system volumes. The
following RPCs specify capabilities that must be validated:</p>
<ul>
<li><code>CreateVolume()</code> (multiple capabilities)</li>
<li><code>ControllerPublishVolume()</code></li>
<li><code>ValidateVolumeCapabilities()</code> (multiple capabilities)</li>
<li><code>GetCapacity()</code> (see below)</li>
<li><code>NodeStageVolume()</code></li>
<li><code>NodePublishVolume()</code></li>
</ul>
<p>Also, CSI plugins that implement the optional <code>GetCapacity()</code> RPC should note that that RPC includes
capabilities too, and if the capacity for mount volumes is not the same as the capacity for block
volumes, that needs to be handled in the implementation of that RPC.</p>
<p>Q: Can CSI plugins support only block volumes and not mount volumes?
A: Yes! This is just the reverse case of supporting mount volumes only. Plugins may return <code>InvalidArgument</code>
for any creation request with an <code>AccessType</code> of <code>VolumeCapability_Mount</code>.</p>
<h2><a class="header" href="#differences-between-block-and-mount-volumes" id="differences-between-block-and-mount-volumes">Differences Between Block and Mount Volumes</a></h2>
<p>The main difference between block volumes and mount volumes is the expected result of the <code>NodePublish()</code>.
For mount volumes, the CO expects the result to be a mounted directory, at <code>TargetPath</code>. For block volumes,
the CO expects there to be a device file at <code>TargetPath</code>. The device file can by a bind-mounted device from
the hosts <code>/dev</code> file system, or it can be a device node created at that location using <code>mknod()</code>.</p>
<p>It's desirable but not required to expose an unfiltered device node. For example, CSI plugins based on
technologies that implement SCSI protocols should expect that pods consuming the block volumes they create
may want to send SCSI commands to the device. This is something that should &quot;just work&quot; by default (subject
to container capabilities) so CSI plugins should avoid anything that would break this kind of use case. The
only hard requirement is that the device implements block reading/writing however.</p>
<p>For plugins with the <code>RPC_STAGE_UNSTAGE_VOLUME</code> capability, the CO doesn't care exactly what is placed at
the <code>StagingTargetPath</code>, but it's worth noting that some CSI RPCs are allowed to pass the plugin either
a staging path or a publish path, so it's important to think carefully about how <code>NodeStageVolume()</code> is
implemented, knowing that either path could get used by the CO to refer to the volume later on. This is
made more challenging because the CSI spec says that <code>StagingTargetPath</code> is always a directory even for
block volumes.</p>
<h2><a class="header" href="#sidecar-deployment" id="sidecar-deployment">Sidecar Deployment</a></h2>
<p>The raw block feature requires the
<a href="external-provisioner.html">external-provisioner</a> and
<a href="external-attacher.html">external-attacher</a> sidecars to be deployed.</p>
<h2><a class="header" href="#kubernetes-cluster-setup" id="kubernetes-cluster-setup">Kubernetes Cluster Setup</a></h2>
<p>The <code>BlockVolume</code> and <code>CSIBlockVolume</code> feature gates need to be enabled on
all Kubernetes masters and nodes.</p>
<pre><code>--feature-gates=BlockVolume=true,CSIBlockVolume=true...
</code></pre>
<ul>
<li>TODO: detail how Kubernetes API raw block fields get mapped to CSI methods/fields.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="topology.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="skip-attach.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="topology.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="skip-attach.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
