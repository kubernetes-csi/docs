<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Ephemeral Local Volumes - Kubernetes CSI Developer Documentation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="This site documents how to develop and deploy a Container Storage Interface (CSI) driver on Kubernetes.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="developing.html"><strong aria-hidden="true">2.</strong> Developing a CSI Driver for Kubernetes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="project-policies.html"><strong aria-hidden="true">2.1.</strong> Versioning, Support, Compatibility Policies</a></li><li class="chapter-item expanded "><a href="kubernetes-changelog.html"><strong aria-hidden="true">2.2.</strong> Kubernetes Changelog</a></li><li class="chapter-item expanded "><a href="kubernetes-cluster-controllers.html"><strong aria-hidden="true">2.3.</strong> Kubernetes Cluster Controllers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="snapshot-controller.html"><strong aria-hidden="true">2.3.1.</strong> Snapshot Controller</a></li><li class="chapter-item expanded "><a href="snapshot-validation-webhook.html"><strong aria-hidden="true">2.3.2.</strong> Snapshot Validation Webhook</a></li><li class="chapter-item expanded "><a href="csi-proxy.html"><strong aria-hidden="true">2.3.3.</strong> CSI Proxy</a></li></ol></li><li class="chapter-item expanded "><a href="sidecar-containers.html"><strong aria-hidden="true">2.4.</strong> Sidecar Containers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="external-attacher.html"><strong aria-hidden="true">2.4.1.</strong> external-attacher</a></li><li class="chapter-item expanded "><a href="external-provisioner.html"><strong aria-hidden="true">2.4.2.</strong> external-provisioner</a></li><li class="chapter-item expanded "><a href="external-resizer.html"><strong aria-hidden="true">2.4.3.</strong> external-resizer</a></li><li class="chapter-item expanded "><a href="external-snapshotter.html"><strong aria-hidden="true">2.4.4.</strong> external-snapshotter</a></li><li class="chapter-item expanded "><a href="livenessprobe.html"><strong aria-hidden="true">2.4.5.</strong> livenessprobe</a></li><li class="chapter-item expanded "><a href="node-driver-registrar.html"><strong aria-hidden="true">2.4.6.</strong> node-driver-registrar</a></li><li class="chapter-item expanded "><a href="cluster-driver-registrar.html"><strong aria-hidden="true">2.4.7.</strong> cluster-driver-registrar</a></li><li class="chapter-item expanded "><a href="external-health-monitor-controller.html"><strong aria-hidden="true">2.4.8.</strong> external-health-monitor-controller</a></li><li class="chapter-item expanded "><a href="external-health-monitor-agent.html"><strong aria-hidden="true">2.4.9.</strong> external-health-monitor-agent</a></li><li class="chapter-item expanded "><a href="external-snapshot-metadata.html"><strong aria-hidden="true">2.4.10.</strong> external-snapshot-metadata</a></li></ol></li><li class="chapter-item expanded "><a href="csi-objects.html"><strong aria-hidden="true">2.5.</strong> CSI objects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="csi-driver-object.html"><strong aria-hidden="true">2.5.1.</strong> CSIDriver Object</a></li><li class="chapter-item expanded "><a href="csi-node-object.html"><strong aria-hidden="true">2.5.2.</strong> CSINode Object</a></li></ol></li><li class="chapter-item expanded "><a href="features.html"><strong aria-hidden="true">2.6.</strong> Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="secrets-and-credentials.html"><strong aria-hidden="true">2.6.1.</strong> Secrets &amp; Credentials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="secrets-and-credentials-storage-class.html"><strong aria-hidden="true">2.6.1.1.</strong> StorageClass Secrets</a></li><li class="chapter-item expanded "><a href="secrets-and-credentials-volume-snapshot-class.html"><strong aria-hidden="true">2.6.1.2.</strong> VolumeSnapshotClass Secrets</a></li><li class="chapter-item expanded "><a href="secrets-and-credentials-volume-group-snapshot-class.html"><strong aria-hidden="true">2.6.1.3.</strong> VolumeGroupSnapshotClass Secrets</a></li></ol></li><li class="chapter-item expanded "><a href="topology.html"><strong aria-hidden="true">2.6.2.</strong> Topology</a></li><li class="chapter-item expanded "><a href="raw-block.html"><strong aria-hidden="true">2.6.3.</strong> Raw Block Volume</a></li><li class="chapter-item expanded "><a href="skip-attach.html"><strong aria-hidden="true">2.6.4.</strong> Skip Attach</a></li><li class="chapter-item expanded "><a href="pod-info.html"><strong aria-hidden="true">2.6.5.</strong> Pod Info on Mount</a></li><li class="chapter-item expanded "><a href="volume-expansion.html"><strong aria-hidden="true">2.6.6.</strong> Volume expansion</a></li><li class="chapter-item expanded "><a href="volume-datasources.html"><strong aria-hidden="true">2.6.7.</strong> Data Sources</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="volume-cloning.html"><strong aria-hidden="true">2.6.7.1.</strong> Cloning</a></li><li class="chapter-item expanded "><a href="snapshot-restore-feature.html"><strong aria-hidden="true">2.6.7.2.</strong> Volume Snapshot &amp; Restore</a></li><li class="chapter-item expanded "><a href="group-snapshot-restore-feature.html"><strong aria-hidden="true">2.6.7.3.</strong> Volume Group Snapshot &amp; Restore</a></li></ol></li><li class="chapter-item expanded "><a href="ephemeral-local-volumes.html" class="active"><strong aria-hidden="true">2.6.8.</strong> Ephemeral Local Volumes</a></li><li class="chapter-item expanded "><a href="volume-limits.html"><strong aria-hidden="true">2.6.9.</strong> Volume Limits</a></li><li class="chapter-item expanded "><a href="storage-capacity-tracking.html"><strong aria-hidden="true">2.6.10.</strong> Storage Capacity Tracking</a></li><li class="chapter-item expanded "><a href="volume-health-monitor.html"><strong aria-hidden="true">2.6.11.</strong> Volume Health Monitoring</a></li><li class="chapter-item expanded "><a href="token-requests.html"><strong aria-hidden="true">2.6.12.</strong> Token Requests</a></li><li class="chapter-item expanded "><a href="support-fsgroup.html"><strong aria-hidden="true">2.6.13.</strong> FSGroup Support</a></li><li class="chapter-item expanded "><a href="csi-windows.html"><strong aria-hidden="true">2.6.14.</strong> CSI Windows</a></li><li class="chapter-item expanded "><a href="prevent-volume-mode-conversion.html"><strong aria-hidden="true">2.6.15.</strong> Volume Mode Conversion</a></li><li class="chapter-item expanded "><a href="cross-namespace-data-sources.html"><strong aria-hidden="true">2.6.16.</strong> Cross-Namespace Data Sources</a></li><li class="chapter-item expanded "><a href="changed-block-tracking.html"><strong aria-hidden="true">2.6.17.</strong> Changed Block Tracking</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="deploying.html"><strong aria-hidden="true">3.</strong> Deploying a CSI Driver on Kubernetes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="example.html"><strong aria-hidden="true">3.1.</strong> Example</a></li></ol></li><li class="chapter-item expanded "><a href="testing-drivers.html"><strong aria-hidden="true">4.</strong> Driver Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="unit-testing.html"><strong aria-hidden="true">4.1.</strong> Unit Testing</a></li><li class="chapter-item expanded "><a href="functional-testing.html"><strong aria-hidden="true">4.2.</strong> Functional Testing</a></li></ol></li><li class="chapter-item expanded "><a href="drivers.html"><strong aria-hidden="true">5.</strong> Drivers</a></li><li class="chapter-item expanded "><a href="api.html"><strong aria-hidden="true">6.</strong> API Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="api/volume-snapshot.html"><strong aria-hidden="true">6.1.</strong> Volume Snapshot</a></li></ol></li><li class="chapter-item expanded "><a href="troubleshooting.html"><strong aria-hidden="true">7.</strong> Troubleshooting</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Kubernetes CSI Developer Documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#pod-inline-volume-support" id="pod-inline-volume-support">Pod Inline Volume Support</a></h1>
<h2><a class="header" href="#status" id="status">Status</a></h2>
<h3><a class="header" href="#csi-ephemeral-inline-volumes" id="csi-ephemeral-inline-volumes">CSI Ephemeral Inline Volumes</a></h3>
<table><thead><tr><th>Status</th><th>Min K8s Version</th><th>Max K8s Version</th></tr></thead><tbody>
<tr><td>Alpha</td><td>1.15</td><td>1.15</td></tr>
<tr><td>Beta</td><td>1.16</td><td>1.24</td></tr>
<tr><td>GA</td><td>1.25</td><td></td></tr>
</tbody></table>
<h3><a class="header" href="#generic-ephemeral-inline-volumes" id="generic-ephemeral-inline-volumes">Generic Ephemeral Inline Volumes</a></h3>
<table><thead><tr><th>Status</th><th>Min K8s Version</th><th>Max K8s Version</th></tr></thead><tbody>
<tr><td>Alpha</td><td>1.19</td><td>1.20</td></tr>
<tr><td>Beta</td><td>1.21</td><td>1.22</td></tr>
<tr><td>GA</td><td>1.23</td><td></td></tr>
</tbody></table>
<h2><a class="header" href="#overview" id="overview">Overview</a></h2>
<p>Traditionally, volumes that are backed by CSI drivers can only be used
with a <code>PersistentVolume</code> and <code>PersistentVolumeClaim</code> object
combination. Two different Kubernetes features allow volumes to follow
the Pod's lifecycle: CSI ephemeral volumes and generic ephemeral
volumes.</p>
<p>In both features, the volumes are specified directly in the pod
specification for ephemeral use cases.  At runtime, nested inline
volumes follow the ephemeral lifecycle of their associated pods where
Kubernetes and the driver handle all phases of volume operations as
pods are created and destroyed.</p>
<p>However, the two features are targeted at different use cases and thus
have different APIs and different implementations.</p>
<blockquote>
<p>See the <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-storage/596-csi-inline-volumes">CSI inline
volumes</a>
and <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-storage/1698-generic-ephemeral-volumes">generic ephemeral
volumes</a>
enhancement proposals for design details. The user facing
documentation for both features is in the <a href="https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/">Kubernetes
documentation</a>.</p>
</blockquote>
<h2><a class="header" href="#which-feature-should-my-driver-support" id="which-feature-should-my-driver-support">Which feature should my driver support?</a></h2>
<p>CSI ephemeral inline volumes are meant for simple, local volumes. All
parameters that determine the content of the volume can be specified
in the pod spec, and only there. Storage classes are not supported and
all parameters are driver specific.</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: some-pod
spec:
  containers:
    ...
  volumes:
      - name: vol
        csi:
          driver: inline.storage.kubernetes.io
          volumeAttributes:
              foo: bar
</code></pre>
<p>A CSI driver is suitable for CSI ephemeral inline volumes if:</p>
<ul>
<li>it serves a special purpose and needs custom per-volume parameters,
like drivers that provide secrets to a pod</li>
<li>it can create volumes when running on a node</li>
<li>fast volume creation is needed</li>
<li>resource usage on the node is small and/or does not need to be exposed
to Kubernetes</li>
<li>rescheduling of pods onto a different node when storage capacity
turns out to be insufficient is not needed</li>
<li>none of the usual volume features (restoring from snapshot,
cloning volumes, etc.) are needed</li>
<li>ephemeral inline volumes have to be supported on Kubernetes clusters
which do not support generic ephemeral volumes</li>
</ul>
<p>A CSI driver is not suitable for CSI ephemeral inline volumes when:</p>
<ul>
<li>provisioning is not local to the node</li>
<li>ephemeral volume creation requires volumeAttributes that should be restricted
to an administrator, for example parameters that are otherwise set in a
StorageClass or PV. Ephemeral inline volumes allow these attributes to be set
directly in the Pod spec, and so are not restricted to an admin.</li>
</ul>
<p>Generic ephemeral inline volumes make the normal volume API (storage
classes, <code>PersistentVolumeClaim</code>) usable for ephemeral inline
volumes.</p>
<pre><code class="language-yaml">kind: Pod
apiVersion: v1
metadata:
  name: some-pod
spec:
  containers:
     ...
  volumes:
    - name: scratch-volume
      ephemeral:
        volumeClaimTemplate:
          metadata:
            labels:
              type: my-frontend-volume
          spec:
            accessModes: [ &quot;ReadWriteOnce&quot; ]
            storageClassName: &quot;scratch-storage-class&quot;
            resources:
              requests:
                storage: 1Gi
</code></pre>
<p>A CSI driver is suitable for generic ephemeral inline volumes if it
supports dynamic provisioning of volumes. No other changes are needed
in the driver in that case. Such a driver can also support CSI
ephemeral inline volumes if desired.</p>
<h2><a class="header" href="#security-considerations" id="security-considerations">Security Considerations</a></h2>
<p>CSI driver vendors that choose to support ephemeral inline volumes are responsible for secure handling of these volumes, and special consideration needs to be given to what volumeAttributes are supported by the driver. As noted above, a CSI driver is not suitable for CSI ephemeral inline volumes when volume creation requires volumeAttributes that should be restricted to an administrator. These attributes are set directly in the Pod spec, and therefore are not automatically restricted to an administrator when used as an inline volume.</p>
<p>CSI inline volumes are only intended to be used for ephemeral storage, and driver vendors should NOT allow usage of inline volumes for persistent storage unless they also provide a third party pod admission plugin to restrict usage of these volumes.</p>
<p>Cluster administrators who need to restrict the CSI drivers that are
allowed to be used as inline volumes within a Pod spec may do so by:</p>
<ul>
<li>Removing <code>Ephemeral</code> from <code>volumeLifecycleModes</code> in the CSIDriver spec, which prevents the driver from being used as an inline ephemeral volume.</li>
<li>Using an admission webhook to restrict how this driver is used.</li>
</ul>
<h2><a class="header" href="#implementing-csi-ephemeral-inline-support" id="implementing-csi-ephemeral-inline-support">Implementing CSI ephemeral inline support</a></h2>
<p>Drivers must be modified (or implemented specifically) to support CSI inline
ephemeral workflows. When Kubernetes encounters an inline CSI volume embedded
in a pod spec, it treats that volume differently. Mainly, the driver will only
receive <code>NodePublishVolume</code>, during the volume's mount phase, and <code>NodeUnpublishVolume</code> when
the pod is going away and the volume is unmounted.</p>
<p>Due to these requirements, ephemeral volumes will not be created using the <a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#controller-service-rpc">Controller
Service</a>,
but the <a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#node-service-rpc">Node
Service</a>,
instead. When the
<a href="https://github.com/kubernetes/kubernetes/blob/70132b0f130acc0bed193d9ba59dd186f0e634cf/pkg/volume/csi/csi_mounter.go#L329">kubelet</a>
calls <em>NodePublishVolume</em>, it is the responsibility of the CSI driver to create the
volume during that call, then publish the volume to the specified location. When
the <code>kubelet</code> calls <em>NodeUnpublishVolume</em>, it is the responsibility of the CSI
driver to delete the volume.</p>
<p>To support inline, a driver must implement the followings:</p>
<ul>
<li>Identity service</li>
<li>Node service</li>
</ul>
<h3><a class="header" href="#csi-extension-specification" id="csi-extension-specification">CSI Extension Specification</a></h3>
<h4><a class="header" href="#a-hrefhttpsgithubcomcontainer-storage-interfacespecblobmasterspecmdnodepublishvolumenodepublishvolumea" id="a-hrefhttpsgithubcomcontainer-storage-interfacespecblobmasterspecmdnodepublishvolumenodepublishvolumea"><a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#nodepublishvolume">NodePublishVolume</a></a></h4>
<h5><a class="header" href="#arguments" id="arguments">Arguments</a></h5>
<ul>
<li><strong><code>volume_id</code></strong>: Volume ID will be created by the Kubernetes and passed to the
driver by the kubelet.</li>
<li><strong><code>volume_context[&quot;csi.storage.k8s.io/ephemeral&quot;]</code></strong>: This value will be
available and it will be equal to <code>&quot;true&quot;</code>.</li>
</ul>
<h5><a class="header" href="#workflow" id="workflow">Workflow</a></h5>
<p>The driver will receive the appropriate arguments as defined above when an
ephemeral volume is requested. The driver will create and publish the volume
to the specified location as noted in the <em>NodePublishVolume</em> request. Volume
size and any other parameters required will be passed in verbatim from the
inline manifest parameters to the <code>NodePublishVolumeRequest.volume_context</code>.</p>
<p>There is no guarantee that NodePublishVolume will be called again after a
failure, regardless of what the failure is. To avoid leaking resources, a CSI
driver must either always free all resources before returning from
NodePublishVolume on error or implement some kind of garbage collection.</p>
<h4><a class="header" href="#a-hrefhttpsgithubcomcontainer-storage-interfacespecblobmasterspecmdnodeunpublishvolumenodeunpublishvolumea" id="a-hrefhttpsgithubcomcontainer-storage-interfacespecblobmasterspecmdnodeunpublishvolumenodeunpublishvolumea"><a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#nodeunpublishvolume">NodeUnpublishVolume</a></a></h4>
<h5><a class="header" href="#arguments-1" id="arguments-1">Arguments</a></h5>
<p>No changes</p>
<h5><a class="header" href="#workflow-1" id="workflow-1">Workflow</a></h5>
<p>The driver is responsible of deleting the ephemeral volume once it has
unpublished the volume. It MAY delete the volume before finishing the request,
or after the request to unpublish is returned.</p>
<h3><a class="header" href="#read-only-volumes" id="read-only-volumes">Read-Only Volumes</a></h3>
<p>It is possible for a CSI driver to provide volumes to Pods as read-only while allowing them to be writeable on the node for kubelet, the driver, and the container runtime. This allows the CSI driver to dynamically update contents of the volume without exposing issues like <a href="https://github.com/kubernetes/kubernetes/issues/60814">CVE-2017-1002102</a>, since the volume is read-only for the end user. It also allows the <code>fsGroup</code> and SELinux context of files to be applied on the node so the Pod gets the volume with the expected permissions and SELinux label.</p>
<p>To benefit from this behavior, the following can be implemented in the CSI driver:</p>
<ul>
<li>The driver provides an admission plugin that sets <code>ReadOnly: true</code> to all volumeMounts of such volumes. We can't trust that this will be done by every user on every pod.</li>
<li>The driver checks that the <code>readonly</code> flag is set in all NodePublish requests. We can't trust that the admission plugin above is deployed on every cluster.</li>
<li>When both conditions above are satisfied, the driver MAY ignore the <code>readonly</code> flag in <a href="https://github.com/container-storage-interface/spec/blob/5b0d4540158a260cb3347ef1c87ede8600afb9bf/csi.proto#L1375">NodePublish</a> and set up the volume as read-write. Ignoring the <code>readonly</code> flag in NodePublish is considered valid CSI driver behavior for inline ephemeral volumes.</li>
</ul>
<p>The presence of <code>ReadOnly: true</code> in the Pod spec tells kubelet to bind-mount the volume to the container as read-only, while the underlying mount is read-write on the host. This is the same behavior used for projected volumes like Secrets and ConfigMaps.</p>
<h3><a class="header" href="#csidriver" id="csidriver">CSIDriver</a></h3>
<p>Kubernetes only allows using a CSI driver for an inline volume if
its <a href="csi-driver-object.html"><code>CSIDriver</code></a> object explicitly declares
that the driver supports that kind of usage in its
<code>volumeLifecycleModes</code> field. This is a safeguard against accidentally
<a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-storage/596-csi-inline-volumes#support-for-inline-csi-volumes">using a driver the wrong way</a>.</p>
<h2><a class="header" href="#references" id="references">References</a></h2>
<ul>
<li><a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/9fdddc2061b9013286e01189b2bf3268276af99b/pkg/hostpath/nodeserver.go#L63-L82">CSI Host Path
driver ephemeral volumes support</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/82507">Issue 82507: Drop VolumeLifecycleModes field from CSIDriver API before
GA</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/75222">Issue 75222: CSI Inline - Update CSIDriver to indicate driver
mode</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#csidriver-v1-storage-k8s-io">CSIDriver support for ephemeral volumes</a></li>
<li><a href="https://github.com/kubernetes-csi/csi-driver-host-path">CSI Hostpath driver</a> - an example driver that supports both modes and determines the mode on a case-by-case basis (for Kubernetes 1.16) or can be deployed with support for just one of the two modes (for Kubernetes 1.15).</li>
<li><a href="https://github.com/kubernetes-csi/csi-driver-image-populator">Image populator plugin</a> - an example CSI driver plugin that uses a container image as a volume.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="group-snapshot-restore-feature.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="volume-limits.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="group-snapshot-restore-feature.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="volume-limits.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="custom.js"></script>
        

        

    </body>
</html>
